---
lab:
    title: 'Azure Databricks を使用したハイパーパラメーターのチューニング'
    module: 'オプションの演習'
---

# ハイパーパラメーターのチューニング用の設定

まず、対話型クラスターを使用して Azure Databricks ワークスペースにアクセスできる必要があります。ワークスペースや必要なクラスターがない場合は、次の手順を実行します。それ以外の場合は、以下の「**データのアップロード**」セクションにスキップできます。2 つの演習を完了するには、**2 つの異なるデータセット**をアップロードする必要があることに注意してください。

## Azure Databricks リソースを作成する

Azure Databricks を使用するには、最初に Azure サブスクリプションに Azure Databricks ワークスペースをデプロイし、ノートブックとコードを実行するクラスターを作成する必要があります。次に、データとノートブックをアップロードして、ワークスペースで実験することができます。

### Azure Databricks ワークスペースをデプロイする

1. [Azure portal](https://portal.azure.com) で、次の設定を指定して新しい **Azure Databricks** リソースを作成します。
   - **サブスクリプション**: *ワークスペースをデプロイする Azure サブスクリプションを選択します。*
   - **リソース グループ**: *新しいリソース グループを作成します。*
   - **ワークスペース名**: *ワークスペースの名前を指定します。*
   - **リージョン**: *デプロイ用としてお近くの場所を選択します。Azure Databricks でサポートされているリージョンのリストについては、[リージョン別の利用可能な Azure サービス](https://azure.microsoft.com/regions/services/)を参照してください。*
   - **価格レベル**: 標準

1. ワークスペースが作成されるまで待ちます。ワークスペース の作成には数分かかります。ワークスペースの作成時に、ポータルの右側に「Azure Databricks のデプロイを送信しています」タイルが表示されます。このタイルを表示するために、ダッシュボードを右へスクロールしなければならない場合があります。スクリーンの上部に進行状況バーも表示されます。いずれかの領域で進行状況を確認できます。

### クラスターを作成する

1. Azure Databricks ワークスペース リソースが作成されたら、ポータルでそのリソースに移動し、「**ワークスペースの起動**」を選択して新しいタブで Databricks ワークスペースを開き、プロンプトが表示されたらサインインします。

1. Databricks ワークスペースの左側のメニューで、「**コンピューティング**」を選択し、「**+ クラスターの作成**」を選択して、次の構成で新しいクラスターを追加します。
   - **名前**: *一意の名前を入力します。*
   - **クラスター モード**: 単一ノード
   - **プール**: 必要ない
   - **Databricks ランタイムのバージョン**: *ランタイムの利用可能な最新バージョンの **ML** エディションを選択します。選択したバージョンが以下であること確認してください。*
      - *GPU を使用**しません***
      - *Scala > **2.11** を含みます*
      - *Spark > **3.0** を含みます*
   - **終了までの時間**: 120 分間の非アクティブ
   - **ノードの種類**: Standard_DS3_v2

1. クラスターが作成されるまで待ちます。これには数分かかる場合があります。クラスターは自動的に開始され、最終的にクラスター名の横にある回転する*保留中*のインジケーターが緑色の丸に変わり、*実行中*のステータスを示します。

### 演習 1 のデータセットをアップロードする

1. `https://github.com/MicrosoftDocs/ml-basics/blob/master/challenges/data/real_estate.csv` をコンピューターにダウンロードして、任意のフォルダ－に **real_estate.csv** として保存します。

1. Databricks ワークスペースの「**データ**」ページで、「**テーブルの作成**」オプションを選択します。

1. 「**ファイル**」領域で、「**参照**」を選択してから、ダウンロードした **real_estate.csv** ファイルを参照します。

1. ファイルがワークスペースにアップロードされたら、「**UI を使用してテーブルを作成**」を選択します。次に、クラスターを選択し、「**テーブルのプレビュー**」を選択します。

1. 次のテーブル属性を指定して、「**テーブルの作成**」を選択します。

    - **テーブル名**: real_estate
    - **データベースで作成**: 既定
    - **ファイルの種類**: CSV
    - **列区切り記号**: , *(コンマ)*
    - **先頭の行を見出しとして使用**: *チェック*
    - **Infer schema**: *チェック*
    - **マルチライン**: *チェック解除*

1. テーブルが作成されたら、ワークスペースで表示します。

### 演習 2 のデータセットをアップロードする

1. `https://github.com/MicrosoftDocs/ml-basics/blob/master/challenges/data/wine.csv` をコンピューターにダウンロードして、任意のフォルダ－に **wine.csv** として保存します。

1. Databricks ワークスペースの「**データ**」ページで、「**テーブルの作成**」オプションを選択します。

1. 「**ファイル**」領域で、「**参照**」を選択してから、ダウンロードした **wine.csv** ファイルを参照します。

1. ファイルがワークスペースにアップロードされたら、「**UI を使用してテーブルを作成**」を選択します。次に、クラスターを選択し、「**テーブルのプレビュー**」を選択します。

1. 次のテーブル属性を指定して、「**テーブルの作成**」を選択します。

    - **テーブル名**: wine
    - **データベースで作成**: 既定
    - **ファイルの種類**: CSV
    - **列区切り記号**: , *(コンマ)*
    - **先頭の行を見出しとして使用**: *チェック*
    - **Infer schema**: *チェック*
    - **マルチライン**: *チェック解除*

1. テーブルが作成されたら、ワークスペースで表示します。

### Databricks ノートブックをインポートする

1. Azure Databricks ワークスペースで、左側のコマンド バーを使用して、「**ワークスペース**」を選択します。次に、「**ユーザー**」を選択し、**&#9751; *your_user_name*** を選択します。

1. ブレードが表示されるので、名前の横にある下向きのシェブロン (**v**) を選択し、「**インポート**」を選択します。

1. 「**ノートブックのインポート**」ダイアログで、次の URL からノートブック アーカイブをインポートします。アーカイブ名のフォルダーが作成され、2 つのノートブックが含まれていることに注意してください。
   - `https://github.com/MicrosoftLearning/dp-090-databricks-ml/blob/master/05%20-%20Hyperparameter%20Tuning.dbc`

## 自動化された MLflow ハイパーパラメーターのチューニング調べる

この演習では、ハイパーパラメーターのチューニングに自動化された MLflow を使用する方法を学びます。

1. ワークスペースの **05 - ハイパーパラメーターのチューニング**のフォルダ－で、**1.0 自動化された MLflow ハイパーパラメーターのチューニング**のノートブックを開きます。

1. 左上のドロップダウン メニューで、クラスターを選択して、ノートブックをそのクラスターに接続します。*(または、接続されていないノートブックで最初のセルを実行するときに、クラスターを接続するように求められます)。*

1. ノートブック内の注意事項を読み、各コード セルを順番に実行します。

## ハイパーパラメーターのチューニングのための Hyperopt を調べる

この演習では、ハイパーパラメーターのチューニングに自動化された MLflow を使用する方法を学びます。

1. ワークスペースの **05 - ハイパーパラメーターのチューニング**のフォルダ－で、**2.0 自動化された MLflow ハイパーパラメーターのチューニング**のノートブックを開きます。

1. 左上のドロップダウン メニューで、クラスターを選択して、ノートブックをそのクラスターに接続します。*(または、接続されていないノートブックで最初のセルを実行するときに、クラスターを接続するように求められます)。*

1. ノートブック内の注意事項を読み、各コード セルを順番に実行します。

## クリーンアップ

今のところ Azure Databricks の操作が終了している場合は、Azure Databricks ワークスペースの「**コンピューティング**」ページで、クラスターを選択し、「**&#9632;終了**」を選択して、シャットダウンします。それ以外の場合は、次の演習のために実行したままにします。
